<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cooking Game</title>
  <link rel="stylesheet" href="/static/styles.css"/>
  <style>
    body {
      display: flex;
      flex-direction: row;
      gap: 2rem;
      padding: 1rem;
      font-family: sans-serif;
    }

    .sidebar {
      width: 25%;
    }

    .main {
      flex: 1;
    }

    .chat-message {
      margin-bottom: 1rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
    }

    h2.player {
      color: darkblue;
    }

    h2.ai {
      color: darkgreen;
    }

    #aria-loading,
    #aria-done {
      position: absolute;
      left: -9999px;
      height: 1px;
      width: 1px;
      overflow: hidden;
    }
  </style>
</head>
<body>

{% include 'header.html' %}

<div class="sidebar">
  <h1>Cooking Game</h1>
  <button onclick="logout()">Logout</button>

  <div class="player-info">
    <p><strong>Player:</strong> <span id="playerName">-</span></p>
    <p><strong>Restaurant:</strong> <span id="restaurantName">-</span></p>
    <p><strong>Day:</strong> <span id="gameDay">1</span></p>
    <p><strong>Money:</strong> $<span id="playerMoney">200.00</span></p>
  </div>

  <div class="inventory">
    <h3>Inventory</h3>
    <ol id="inventoryList">
      <li>Loading...</li>
    </ol>
  </div>
</div>

<div class="main">
  <div id="aria-loading" role="status" aria-live="polite"></div>
  <div id="aria-done" role="status" aria-live="polite"></div>

  <div class="game-log" id="chatLog"></div>

  <form id="chatForm">
    <input type="text" id="messageInput" placeholder="What do you do?" required />
    <button type="submit">Send</button>
  </form>
</div>

{% include 'footer.html' %}

<script>
  const chatForm = document.getElementById("chatForm");
  const chatLog = document.getElementById("chatLog");
  const messageInput = document.getElementById("messageInput");

  const playerName = document.getElementById("playerName");
  const restaurantName = document.getElementById("restaurantName");
  const gameDay = document.getElementById("gameDay");
  const playerMoney = document.getElementById("playerMoney");
  const inventoryList = document.getElementById("inventoryList");

  const ariaLoading = document.getElementById("aria-loading");
  const ariaDone = document.getElementById("aria-done");

  const userId = localStorage.getItem("user_id");

  if (!userId) {
    window.location.href = "/login-page";
  }

  function logout() {
    localStorage.removeItem("user_id");
    window.location.href = "/login-page";
  }

  async function loadGameState() {
    try {
      const response = await fetch("/api/state", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId }),
      });

      const data = await response.json();

      if (data.error) {
        console.error("State load error:", data.error);
        return;
      }

      playerName.textContent = data.player || "-";
      restaurantName.textContent = data.restaurant || "-";
      gameDay.textContent = data.day || "1";
      playerMoney.textContent = data.money?.toFixed(2) || "200.00";

      inventoryList.innerHTML = "";
      const inv = data.inventory || {};
      const keys = Object.keys(inv);
      if (keys.length === 0) {
        inventoryList.innerHTML = "<li>None</li>";
      } else {
        keys.forEach((key) => {
          const item = document.createElement("li");
          item.textContent = `${key}: ${inv[key]}`;
          inventoryList.appendChild(item);
        });
      }

    } catch (err) {
      console.error("Failed to load game state:", err);
    }
  }

  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    messageInput.value = "";

    const userMsg = document.createElement("div");
    userMsg.className = "chat-message";
    userMsg.innerHTML = `<h2 class="player">Player says:</h2><p>${message}</p>`;
    chatLog.appendChild(userMsg);

    ariaLoading.textContent = "AI is responding...";

    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, user_id: userId }),
    });

    const result = await response.json();

    if (result.error) {
      const errorMsg = document.createElement("div");
      errorMsg.className = "chat-message";
      errorMsg.innerHTML = `<p style="color:red;"><strong>Error:</strong> ${result.error}</p>`;
      chatLog.appendChild(errorMsg);
      return;
    }

    const aiMsg = document.createElement("div");
    aiMsg.className = "chat-message";
    aiMsg.innerHTML = `<h2 class="ai">AI says:</h2><p>${result.response}</p>`;
    chatLog.appendChild(aiMsg);

    ariaLoading.textContent = "";
    ariaDone.textContent = "AI says: ";

    playerName.textContent = result.player || "-";
    restaurantName.textContent = result.restaurant || "-";
    gameDay.textContent = result.day || "1";
    playerMoney.textContent = result.money?.toFixed(2) || "200.00";

    inventoryList.innerHTML = "";
    const inv = result.inventory || {};
    const keys = Object.keys(inv);
    if (keys.length === 0) {
      inventoryList.innerHTML = "<li>None</li>";
    } else {
      keys.forEach((key) => {
        const item = document.createElement("li");
        item.textContent = `${key}: ${inv[key]}`;
        inventoryList.appendChild(item);
      });
    }
  });

  messageInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      chatForm.requestSubmit();
    }
  });

  window.addEventListener("DOMContentLoaded", loadGameState);
</script>

</body>
</html>
